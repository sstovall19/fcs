(function() { function stripHtml(value) { return value.replace(/<.[^<>]*?>/g, ' ').replace(/&nbsp;|&#160;/gi, ' ') .replace(/[0-9.(),;:!?%#$'"_+=\/-]*/g,''); } jQuery.validator.addMethod("maxWords", function(value, element, params) { return this.optional(element) || stripHtml(value).match(/\b\w+\b/g).length < params; }, jQuery.validator.format("Please enter {0} words or less.")); jQuery.validator.addMethod("minWords", function(value, element, params) { return this.optional(element) || stripHtml(value).match(/\b\w+\b/g).length >= params; }, jQuery.validator.format("Please enter at least {0} words.")); jQuery.validator.addMethod("rangeWords", function(value, element, params) { return this.optional(element) || stripHtml(value).match(/\b\w+\b/g).length >= params[0] && value.match(/bw+b/g).length < params[1]; }, jQuery.validator.format("Please enter between {0} and {1} words.")); })(); jQuery.validator.addMethod("letterswithbasicpunc", function(value, element) { return this.optional(element) || /^[a-z-.,()'\"\s]+$/i.test(value); }, "Letters or punctuation only please"); jQuery.validator.addMethod("alphanumeric", function(value, element) { return this.optional(element) || /^\w+$/i.test(value); }, "Letters, numbers, spaces or underscores only please"); jQuery.validator.addMethod("lettersonly", function(value, element) { return this.optional(element) || /^[a-z]+$/i.test(value); }, "Letters only please"); jQuery.validator.addMethod("nowhitespace", function(value, element) { return this.optional(element) || /^\S+$/i.test(value); }, "No white space please"); jQuery.validator.addMethod("ziprange", function(value, element) { return this.optional(element) || /^90[2-5]\d\{2}-\d{4}$/.test(value); }, "Your ZIP-code must be in the range 902xx-xxxx to 905-xx-xxxx"); jQuery.validator.addMethod("integer", function(value, element) { return this.optional(element) || /^-?\d+$/.test(value); }, "A positive or negative non-decimal number please"); jQuery.validator.addMethod("street", function(value, element) { return this.optional(element) || /^[a-zA-Z0-9-\/] ?([a-zA-Z0-9-\/]|[a-zA-Z0-9-\/] )*[a-zA-Z0-9-\/]$/.test(value); }, "Invalid street address"); jQuery.validator.addMethod("city", function(value, element) { return this.optional(element) || /^[a-zA-z] ?([a-zA-z]|[a-zA-z] )*[a-zA-z]$/.test(value); }, "Invalid city"); jQuery.validator.addMethod( "vinUS", function(v){ if (v.length != 17) return false; var i, n, d, f, cd, cdv; var LL = ["A","B","C","D","E","F","G","H","J","K","L","M","N","P","R","S","T","U","V","W","X","Y","Z"]; var VL = [1,2,3,4,5,6,7,8,1,2,3,4,5,7,9,2,3,4,5,6,7,8,9]; var FL = [8,7,6,5,4,3,2,10,0,9,8,7,6,5,4,3,2]; var rs = 0; for(i = 0; i < 17; i++){ f = FL[i]; d = v.slice(i,i+1); if(i == 8){ cdv = d; } if(!isNaN(d)){ d *= f; } else{ for(n = 0; n < LL.length; n++){ if(d.toUpperCase() === LL[n]){ d = VL[n]; d *= f; if(isNaN(cdv) && n == 8){ cdv = LL[n]; } break; } } } rs += d; } cd = rs % 11; if(cd == 10){cd = "X";} if(cd == cdv){return true;} return false; }, "The specified vehicle identification number (VIN) is invalid." ); jQuery.validator.addMethod( "dateITA", function(value, element) { var check = false; var re = /^\d{1,2}\/\d{1,2}\/\d{4}$/; if( re.test(value)){ var adata = value.split('/'); var gg = parseInt(adata[0],10); var mm = parseInt(adata[1],10); var aaaa = parseInt(adata[2],10); var xdata = new Date(aaaa,mm-1,gg); if ( ( xdata.getFullYear() == aaaa ) && ( xdata.getMonth () == mm - 1 ) && ( xdata.getDate() == gg ) ) check = true; else check = false; } else check = false; return this.optional(element) || check; }, "Please enter a correct date" ); jQuery.validator.addMethod("dateNL", function(value, element) { return this.optional(element) || /^\d\d?[\.\/-]\d\d?[\.\/-]\d\d\d?\d?$/.test(value); }, "Vul hier een geldige datum in." ); jQuery.validator.addMethod("time", function(value, element) { return this.optional(element) || /^([01]\d|2[0-3])(:[0-5]\d){0,2}$/.test(value); }, "Please enter a valid time, between 00:00 and 23:59"); jQuery.validator.addMethod("time12h", function(value, element) { return this.optional(element) || /^((0?[1-9]|1[012])(:[0-5]\d){0,2}(\ [AP]M))$/i.test(value); }, "Please enter a valid time, between 00:00 am and 12:00 pm"); jQuery.validator.addMethod("phoneUS", function(phone_number, element) { phone_number = phone_number.replace(/\s+/g, ""); return this.optional(element) || phone_number.length > 9 && phone_number.match(/^(1-?)?(\([2-9]\d{2}\)|[2-9]\d{2})-?[2-9]\d{2}-?\d{4}$/); }, "Please specify a valid phone number"); jQuery.validator.addMethod('phoneUK', function(phone_number, element) { return this.optional(element) || phone_number.length > 9 && phone_number.match(/^(\(?(0|\+44)[1-9]{1}\d{1,4}?\)?\s?\d{3,4}\s?\d{3,4})$/); }, 'Please specify a valid phone number'); jQuery.validator.addMethod('mobileUK', function(phone_number, element) { return this.optional(element) || phone_number.length > 9 && phone_number.match(/^((0|\+44)7(5|6|7|8|9){1}\d{2}\s?\d{6})$/); }, 'Please specify a valid mobile number'); jQuery.validator.addMethod("strippedminlength", function(value, element, param) { return jQuery(value).text().length >= param; }, jQuery.validator.format("Please enter at least {0} characters")); jQuery.validator.addMethod("email2", function(value, element, param) { return this.optional(element) || /^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)*(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i.test(value); }, jQuery.validator.messages.email); jQuery.validator.addMethod("url2", function(value, element, param) { return this.optional(element) || /^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)*(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(value); }, jQuery.validator.messages.url); jQuery.validator.addMethod("creditcardtypes", function(value, element, param) { if (/[^0-9-]+/.test(value)) return false; value = value.replace(/\D/g, ""); var validTypes = 0x0000; if (param.mastercard) validTypes |= 0x0001; if (param.visa) validTypes |= 0x0002; if (param.amex) validTypes |= 0x0004; if (param.dinersclub) validTypes |= 0x0008; if (param.enroute) validTypes |= 0x0010; if (param.discover) validTypes |= 0x0020; if (param.jcb) validTypes |= 0x0040; if (param.unknown) validTypes |= 0x0080; if (param.all) validTypes = 0x0001 | 0x0002 | 0x0004 | 0x0008 | 0x0010 | 0x0020 | 0x0040 | 0x0080; if (validTypes & 0x0001 && /^(51|52|53|54|55)/.test(value)) { return value.length == 16; } if (validTypes & 0x0002 && /^(4)/.test(value)) { return value.length == 16; } if (validTypes & 0x0004 && /^(34|37)/.test(value)) { return value.length == 15; } if (validTypes & 0x0008 && /^(300|301|302|303|304|305|36|38)/.test(value)) { return value.length == 14; } if (validTypes & 0x0010 && /^(2014|2149)/.test(value)) { return value.length == 15; } if (validTypes & 0x0020 && /^(6011)/.test(value)) { return value.length == 16; } if (validTypes & 0x0040 && /^(3)/.test(value)) { return value.length == 16; } if (validTypes & 0x0040 && /^(2131|1800)/.test(value)) { return value.length == 15; } if (validTypes & 0x0080) { return true; } return false; }, "Please enter a valid credit card number."); jQuery.validator.addMethod("ipv4", function(value, element, param) { return this.optional(element) || /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/i.test(value); }, "Please enter a valid IP v4 address."); jQuery.validator.addMethod("ipv6", function(value, element, param) { return this.optional(element) || /^((([0-9A-Fa-f]{1,4}:){7}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){6}:[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){5}:([0-9A-Fa-f]{1,4}:)?[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){4}:([0-9A-Fa-f]{1,4}:){0,2}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){3}:([0-9A-Fa-f]{1,4}:){0,3}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){2}:([0-9A-Fa-f]{1,4}:){0,4}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){6}((\b((25[0-5])|(1\d{2})|(2[0-4]\d)|(\d{1,2}))\b)\.){3}(\b((25[0-5])|(1\d{2})|(2[0-4]\d)|(\d{1,2}))\b))|(([0-9A-Fa-f]{1,4}:){0,5}:((\b((25[0-5])|(1\d{2})|(2[0-4]\d)|(\d{1,2}))\b)\.){3}(\b((25[0-5])|(1\d{2})|(2[0-4]\d)|(\d{1,2}))\b))|(::([0-9A-Fa-f]{1,4}:){0,5}((\b((25[0-5])|(1\d{2})|(2[0-4]\d)|(\d{1,2}))\b)\.){3}(\b((25[0-5])|(1\d{2})|(2[0-4]\d)|(\d{1,2}))\b))|([0-9A-Fa-f]{1,4}::([0-9A-Fa-f]{1,4}:){0,5}[0-9A-Fa-f]{1,4})|(::([0-9A-Fa-f]{1,4}:){0,6}[0-9A-Fa-f]{1,4})|(([0-9A-Fa-f]{1,4}:){1,7}:))$/i.test(value); }, "Please enter a valid IP v6 address."); jQuery.validator.addMethod("pattern", function(value, element, param) { return this.optional(element) || param.test(value); }, "Invalid format."); var item_description = {}; var item_name = {}; var item_price = {}; var item_mrc = {}; var price_model = {}; var bundle_list = {}; var volume_discount = {}; var prepay_discount = {}; var promo = {}; var term_total = 0.00; var term_total_prepay = 0.00; var prepay_discount_percentage = 0; var sync_changes = false; var progress_xhr; var shipping_xhr; var shipping_calculator_xhr; var contact_xhr; var discount_xhr; var shipping_saved = false; var shipping_status = false; var shipping_error = false; var contact_saved = false; var contact_status = false; var contact_error = false; var progress_saved = false; var progress_status = false; var progress_error = false; var discount_saved = false; var discount_status = false; var discount_error = false; var is_single_pane = false; var review_scroll; var review_left; var review_top; var container_size = {}; var components_size = {}; var displayed_preview_item; window.onbeforeunload = function(e) { if(progress_xhr && progress_xhr.readyState < 4) { e = e || window.event; if(e) { return 'Your quote information is still being saved to the server.'; } return e; } }; function populateItemNames(bundle_id, description, display_name, base_price, mrc_price){ bundle_list[bundle_id] = 1; item_description[bundle_id] = description; item_name[bundle_id] = display_name; item_price[bundle_id] = base_price; item_mrc[bundle_id] = mrc_price; price_model[bundle_id] = {}; } function populatePrice_model(id, modelName){ price_model[id][modelName] = true; } function populateBundle(bundle, val, flag){ if(flag){ volume_discount[bundle] = val; }else{ prepay_discount[bundle] = val; } } function createDialog(){ $('#status-window').dialog({ modal: true, autoOpen: false, buttons: [], closeOnEscape: false, draggable: false, resizable: false, show: 'slow', open: function() { $(this).parent().children().children("a.ui-dialog-titlebar-close").remove(); } }); } function bundleOptionsTest(){ bundle_dependency_options_test = [ { bundle_id: 'ALLSTATE', provides_bundle_id: 83, provides_bundle_id_multiplier: 1 }, { bundle_id: 83, provides_bundle_id: 82, provides_bundle_id_multiplier: .75 }, { bundle_id: 83, provides_bundle_id: 87, provides_bundle_id_multiplier: 1 }, { bundle_id: 83, provides_bundle_id: 57, provides_bundle_id_multiplier: .1 }, { bundle_id: 83, provides_bundle_id: 86, provides_bundle_id_multiplier: .2 }, { bundle_id: 83, provides_bundle_id: 89, provides_bundle_id_multiplier: .1 }, { bundle_id: 83, provides_bundle_id: 42, provides_bundle_id_multiplier: 1 }, { bundle_id: 89, provides_bundle_id_multiplier: 1, provides_bundle_id: 49 }, { bundle_id: 42, provides_bundle_id: 54, provides_bundle_id_multiplier: 1 }, { bundle_id: 42, provides_bundle_id: 58, provides_bundle_id_multiplier: .1 } ]; } function validateCategoryForm(){ $('#form_Shipping').validate({ errorDiv: 'validation-block-Shipping', ignore: '', rules: { addr1: { required: true, street: true, rangelength: [ 5, 36 ] }, addr2: { required: false, street: true, maxlength: 36 }, city: { required: true, city: true, rangelength: [ 2, 36 ] }, country: { required: true } }, messages: { addr1: { required: "Street Address is required", street: "Invalid street address", rangelength: "Invalid street address length" }, addr2: { street: "Invalid additional street address info", maxlength: "Additional street address info may only be 36 characters" }, city: { required: "City is required", city: "Invalid city", rangelength: "Invalid city length" }, country: { required: "Country is required" } } }); $('#form_Discounts').validate({ errorDiv: 'validation-block-Discounts', ignore: '', rules: { order_discount: { digits: true, max: 100 } }, messages: { order_discount: { digits: 'Please enter only numbers for the discount percentage.', max: 'Enter a percentage less than 100%' } } }); $('#form_Contact').validate({ errorDiv: 'validation-block-Contact', ignore: '', rules: { first_name: { required: true, lettersonly: true, rangelength: [ 2, 36 ] }, last_name: { required: true, lettersonly: true, rangelength: [ 2, 36 ] }, email: { required: true, email: true }, email_confirm: { required: true, email: true, equalTo: '#email' }, company_name: { required: true, letterswithbasicpunc: true, maxlength: 36 }, website: { required: false, url: true, maxlength: 64 } }, messages: { first_name: { required: "First name is required", lettersonly: "Only letters are allowed for your first name", rangelength: "Please enter between 2 and 36 characters for your first name" }, last_name: { required: "Last name is required", lettersonly: "Only letters are allowed for your last name", rangelength: "Please enter between 2 and 36 characters for your last name" }, email: { required: "Your email address is required", email: "Please enter a valid email address" }, email_confirm: { required: "Please confirm your email address", email: "Please enter a valid confirmation email address", equalTo: "Your email and confirmation email addresses to not match" }, company_name: { required: "Company name is required", letterswithbasicpunc: "Invalid company name", maxlength: 'Company name is too long. Please enter 36 or fewer characters.' }, website: { url: "Invalid website URL", maxlength: 'Website URL must be 64 or fewer characters.' } } }); } function onPageLoad(){ createDialog(); bundleOptionsTest(); container_size.width = $('#form_container').width(); container_size.height = $('#form_container').height(); components_size.width = $('#form_components').width(); components_size.height = $('#form_components').height(); } function initializeButtons(){ $('.next_button').each(function() { $(this).button({ icons: { secondary: 'ui-icon-play' } }); }); $('#submit_button').button({ icons: { secondary: 'ui-icon-play' } }); $('#review_button').button({ icons: { secondary: 'ui-icon-play' } }); $('.nav_next_button:not(.nav_hidden)').last().hide(); $('.nav_prev_button:not(.nav_hidden)').first().hide(); $('.nav_review_button:not(.nav_hidden):not(:last)').hide(); $('.next_button,.nav_next_button').click(function() { var selectedTab = $("#form_components").tabs('option', 'selected'); $("#form_components").tabs('option', 'selected', selectedTab + 1); }); $('.prev_button,.nav_prev_button').click(function() { var selectedTab = $("#form_components").tabs('option', 'selected'); $("#form_components").tabs('option', 'selected', selectedTab - 1); }); $('#close_review_window').button({ icons: { primary: 'ui-icon-circle-close' } }); } function submitQuote(){ $('#submit-button').click(function() { $('#review-window').fadeOut(); $('#close_review_window').fadeOut(); $('#submit_button').fadeOut(); if(validate_forms() == false) { return false; } $(this).addClass('ui-state-disabled').attr('disabled', 'disabled'); $('#status-window').dialog('open'); $('#status-message').text('Preparing..'); shipping_saved = false; contact_saved = false; progress_saved = false; save_shipping(); shipping_status = setInterval(function() { if(shipping_saved == true) { shipping_saved = false; clearInterval(shipping_status); if(shipping_error && shipping_error != "") { $('#status-window').dialog('close'); } else { save_progress(); progress_status = setInterval(function() { if(progress_saved == true) { progress_saved = false; clearInterval(progress_status); if(progress_error) { $('#status-window').dialog('close'); alert(progress_error); } else { save_contact(); contact_status = setInterval(function() { if(contact_saved == true) { contact_saved = false; clearInterval(contact_status); if(contact_error) { $('#status-window').dialog('close'); } else { submit_quote(); } } }, 100); } } }, 100); } } }, 100); }); $('#restart').click(function() { window.location = '/?m=Sales.Create_Quote&action=reset_quote'; }); $('#retrieve_quote').click(function() { $('#edit-quote-form').fadeIn().css('z-Index', z_index()); $('#retrieve_quote_id').focus(); var e = $(this).parent(); $(e).addClass('ui-state-disabled'); $('#close-edit-quote-form').click(function() { $('#edit-quote-form').fadeOut(); $(e).removeClass('ui-state-disabled'); }); }); } function selectElChange(){ $('.top_preview_form_select_element').change(function() { var bundle_id = $(this).val(); var e = $('.top_preview_form_element[item_id="'+bundle_id+'"]'); $(e).parent().children().removeClass('ui-state-highlight').addClass('ui-state-disabled'); $(e).removeClass('ui-state-disabled').addClass('ui-state-highlight'); top_preview_form_element_hover($(e)); }); $('.bundle_selector').change(function() { var bundle_id = $(this).val(); var e = $('.bundle_select_form_element[item_id="'+bundle_id+'"]'); $(e).parent().children().removeClass('ui-state-highlight').addClass('ui-state-disabled'); $(e).removeClass('ui-state-disabled').addClass('ui-state-highlight'); bundle_select_form_element_hover($(e)); }); } function populateFromServer(session_store){ for(i in session_store) { var e; var value; var change; if($('input[name="'+i+'"]').length > 0) { e = $('input[name="'+i+'"]'); value = session_store[i].value; } else { e = $('option[value="'+session_store[i].id+'"]').parent(); value = session_store[i].id; change = 1; } if(e) { if(session_store[i].is_rented > 0) { $('.mrc_'+i).attr('checked', 'checked'); } $(e).val(value).change(); } } } function populateShippingInfo(shipping_store){ for(i in shipping_store) { var e; var value; if($('input[name="'+i+'"]').length > 0) { e = $('input[name="'+i+'"]'); value = shipping_store[i]; } else { e = $('select[name="'+i+'"]'); value = shipping_store[i]; } if(e) { $(e).val(value).change(); } } } function populateContactInfo(contact_store){ for(i in contact_store) { var e; var value; if($('input[name="'+i+'"]').length > 0) { e = $('input[name="'+i+'"]'); value = contact_store[i]; } else { e = $('select[name="'+i+'"]'); value = contact_store[i]; } if(e) { $(e).val(value).change(); } } } function updateReviewPanel(){ $('.review_results').display_review(); $('input:not(.no_sync),select:not(.no_sync)').change(function() { sync_changes = true; $('.review_results').display_review(); }); } function toggleTabs(){ $('#tabs_destroy').click(function() { if(is_single_pane != true) { $('div.validation-class').remove(); $('.form_category_div').addClass('single_pane'); $('#form_components').tabs('destroy') $('.ui-tabs-panel,.navtabs_text').hide(); $('#form_categories').hide(); $('.next_button').fadeOut(); $('#submit_button').css('bottom', '-10px').show().position({ my: "right bottom", at: "right top", of: "#Contact"}); is_single_pane = true; $('#tabs_destroy').find('.quote_top_nav_text').first().text('Category view'); var margin = $('#form_container').height() - $('#form_components').height(); var h = margin; $('.form_category_div').each(function() { h = h + $(this).parent().outerHeight() + margin; }); $('#form_components').height(h); $('#form_container').height(h+margin); $('#review_panel').height($(window).height()-50).mCustomScrollbar("update"); var spos = $('.form_category_div').last(); var review_width = $('#review_panel').width(); review_scroll = setInterval(function() { if(is_single_pane == true) { if(!review_left) { p = $('#review_panel').position(); review_left = p.left; review_top = p.top; } var t = $(window).scrollTop(); t = t-review_top; if(t < review_top) t = review_top; $('#review_panel').css('position', 'absolute').css('top', t).css('left',review_left); } }, 1000); } else { clearInterval(review_scroll); $('#form_container').width(container_size.width).height(container_size.height); $('#review_panel').height(414); $('.form_category_div').removeClass('single_pane'); $('#form_components').css('overflow', 'hide'); $('.ui-tabs-panel,.navtabs_text').show(); $('#form_categories').show(); $('#form_components').tabs({ select: function(event, ui) { var curTabPanel = $('#form_components .ui-tabs-panel:not(.ui-tabs-hide)').attr('id'); if($('#form_'+curTabPanel).valid() != true) { $('#icon_'+curTabPanel).addClass('category_icon_error'); return false; } else { $('#icon_'+curTabPanel).removeClass('category_icon_error'); } $('.review_results').display_review(); var tab_num = $('#form_components').tabs("length") - 1; if(ui.index == tab_num) { $('.next_button').hide(); $('#review_button').fadeIn().position({ my: "right bottom", at: "right top", of: "#form_categories"}); } else { $('#review_button').hide(); $('.next_button').fadeIn().position({ my: "right bottom", at: "right top", of: "#form_categories"}); } if(ui.panel.id == 'Shipping' || ui.panel.id == 'Contact') { $('#review_panel').mCustomScrollbar('scrollTo', 'bottom').css('z-Index', z_index()); } else { $('#review_panel').mCustomScrollbar('scrollTo', '#review_'+ui.panel.id); } save_progress(); } }); $('#form_components').css('overflow', 'hide').width(components_size.width).height(components_size.height); $('#tabs_destroy').find('.quote_top_nav_text').first().text('View as list'); is_single_pane = false; $('#review_panel').mCustomScrollbar("update"); } }); } function createCustomeScroll(){ $(".display_right_preview_form").each(function() { $(this).mCustomScrollbar({ scrollButtons: { enable: true }, autoDraggerLength: true, advanced:{ updateOnBrowserResize:true, updateOnContentResize:false, autoExpandHorizontalScroll:false } }); }); } function createFormComponents(flag){ $('#form_components').tabs({ select: function(event, ui) { var curTabPanel = $('#form_components .ui-tabs-panel:not(.ui-tabs-hide)').attr('id'); if($('#form_'+curTabPanel).valid() != true) { $('#icon_'+curTabPanel).parent().addClass('category_icon_error'); return false; } else { $('#icon_'+curTabPanel).parent().removeClass('category_icon_error'); } $('.review_results').display_review(); var tab_num = $('#form_components').tabs("length") - 1; if(ui.index == tab_num) { $('.next_button').hide(); $('#review_button').fadeIn().position({ my: "right bottom", at: "right top", of: "#form_categories"}).css('z-Index', z_index()); } else { $('#review_button').hide(); $('.next_button').fadeIn().position({ my: "right bottom", at: "right top", of: "#form_categories"}).css('z-Index', z_index()); } if(ui.panel.id == 'Shipping' || ui.panel.id == 'Contact') { } else { $('#review_panel').mCustomScrollbar('scrollTo', '#review_'+ui.panel.id); } save_progress(); } }); $( ".tabs-bottom .ui-tabs-nav, .tabs-bottom .ui-tabs-nav > *" ) .removeClass( "ui-corner-all ui-corner-top" ) .addClass( "ui-corner-bottom" ); $( ".tabs-bottom .ui-tabs-nav" ).appendTo( ".tabs-bottom" ); $('.next_button').fadeIn().position({ my: "right bottom", at: "right top", of: "#form_categories"}).css('z-Index', z_index()); } function selectDeployment(){ $("#deployment_selection").each(function() { $(this).find('.deployment_radio').map(function(index, element) { var txt = $(element).text(); var val = $(element).attr('value'); var name = $(element).attr('icon'); $(element).html('<img src="/iconify?icon='+name+'">'); $(element).css('cursor', 'pointer'); $(element).hover(function() { $('#deployment_description').text($(element).attr('title')); $(this).parent().parent().addClass('deployment_icon_hover'); }); $(element).click(function() { $('#deployment_id').val(val); $('#status-message').text('Loading available options...'); $('#status-window').dialog('open'); $('#deployment_form').submit(); }); }); $(this).find('.deployment_icon').map(function(index, element) { $(this).hover(function() { $(this).addClass('deployment_icon_hover'); }); $(this).mouseout(function() { $(this).removeClass('deployment_icon_hover'); }); }); }); } function formLabelHandler(){ $('.form_label,.form_label_no_clear').hover(function() { var category_id = $(this).attr('category_id'); var description = $(this).attr('description'); var no_image = false; if($(this).hasClass('no_image')) no_image = true; var item = $(this).text(); if(displayed_preview_item == item) return false; displayed_preview_item = item; var img_html = ''; if(no_image == false) img_html = '<img src="/iconify?&w=100&h=100&icon='+item+'" align="left" width="100" height="100">'; $('#preview_panel_'+category_id).fadeOut(200, function() { $('#preview_panel_'+category_id).html('<h4>'+item+'</h4><p>'+img_html+description).fadeIn('slow'); }); }); $('.form_element :input').hover(function() { var label = $(this).parent().prevAll('.form_label:first'); var category_id = $(label).attr('category_id'); var description = $(label).attr('description'); var no_image = false; if($(label).hasClass('no_image')) no_image = true; var item = $(label).text(); if(displayed_preview_item == item) return false; displayed_preview_item = item; var img_html = ''; if(no_image == false) img_html = '<img src="/iconify?&w=100&h=100&icon='+item+'" align="left" width="100" height="100">'; $('#preview_panel_'+category_id).fadeOut(200, function() { $('#preview_panel_'+category_id).html('<h4>'+item+'</h4><p>'+img_html+description).fadeIn('slow'); }); }); } function previewHandlers(){ $('.top_preview_form_element').hover(function() { var category_id = $(this).attr('category_id'); var item_id = $(this).attr('item_id'); top_preview_form_hover($(this), category_id, item_id); }); $('.top_preview_form_element').click(function() { var element = $(this); var category_id = $(this).attr('category_id'); var item_id = $(this).attr('item_id'); $('#top_preview_form_select_'+category_id).val(item_id).change(); $('.category_id_'+category_id).each(function() { $(this).addClass('ui-state-disabled').removeClass('ui-state-highlight'); }); element.removeClass('ui-state-disabled').addClass('ui-state-highlight'); $('.next_button').fadeIn().position({ my: "right bottom", at: "right top", of: "#form_categories"}).css('z-Index', z_index()); }); $('.top_preview_form_element').mouseout(function() { var category_id = $(this).attr('category_id'); var sel = $('.top_preview_form_element.ui-state-highlight.category_id_'+category_id); top_preview_form_hover(sel, category_id, sel.attr('item_id')); }); } function preCatHandlers(){ $('.bundle_select_form_element').hover(function() { var category_id = $(this).attr('category_id'); var item_id = $(this).attr('item_id'); bundle_select_form_hover($(this), category_id, item_id); }); $('.bundle_select_form_element').click(function() { var element = $(this); var category_id = $(this).attr('category_id'); var item_id = $(this).attr('item_id'); $('.bundle_selector.category_id_'+category_id).val(item_id).change(); $('.category_id_'+category_id).each(function() { $(this).addClass('ui-state-disabled').removeClass('ui-state-highlight'); }); element.removeClass('ui-state-disabled').addClass('ui-state-highlight'); $('#bundle_select_submit').fadeIn(); }); $('.bundle_select_form_element').mouseout(function() { var category_id = $(this).attr('category_id'); var sel = $('.bundle_select_form_element.ui-state-highlight.category_id_'+category_id); bundle_select_form_hover(sel, category_id, sel.attr('item_id')); }); } function reviewButtonHandler(){ $('.nav_review_button').click(function() { $('#review-window-panel').display_review(); $('#review-window').fadeIn().css('z-Index', z_index()+1); return; var review_html = $('#review_panel').html(); $('#review-window-panel').empty().append(review_html); $('#review-window').fadeIn().css('z-Index', z_index()); $('#review-window .review_title').text('Quote Review'); $('#review-window .review_category').addClass('review_window_category'); $("#review-window").mCustomScrollbar("update"); $('#submit_button').fadeIn().position({ my: "right bottom", at: "right bottom", of: "#review-window-panel"}).css('z-Index', z_index()+1); $('#close_review_window').fadeIn().position({ my: "right bottom", at: "left bottom", of: "#submit_button"}).css('z-Index', z_index()+1); }); } function closeReviewWindowHandler(){ $('#close-review-window').click(function() { $('#review-window').fadeOut(); }); } function applyManagerDiscountHandler(){ $('#order_discount_submit').click(function() { if(!$('#form_Discounts').valid()) return false; var discount = $('#order_discount').val(); discount = parseFloat(discount); if(discount) { $('#status-message').text('Applying discount...'); $('#status-window').dialog('open'); var url = '/'; var data = { mode: 'Sales.Create_Quote', action: 'apply_discount', discount: discount }; $.ajax({ url: url, data: data, dataType: 'JSON', type: 'POST', success: function(data) { if(data.success) { info('Discount of '+discount+'% has been applied.'); } else { alert('Could not apply discount of '+discount+'% because '+data.error); } }, complete: function() { $('#status-window').dialog('close'); } }); } }); } function countrySelectorHandler(){ $('#country').change(function() { if($(this).val()) { if($(this).find(':selected').hasClass('requires_state_prov')) { $('#state_prov').rules('add', { required: true, messages: { required: 'State / Province is required' } }); $('#state_prov').empty().append('<option value="">Loading...</option>'); var country = $(this).val(); $.ajax({ url: 'http: type: 'GET', dataType: 'JSONp', data: { mode: 'Sales.Create_Quote', action: 'state_prov_list', country: country, user: 'dev', api_key: '0bce4abc80a807e1ef63ac2c05b04af1' }, success: function(data) { $('#state_prov').empty().append('<option value="">Select</option>'); confirm(data.guid); if(data && data.state_prov_list) { $('#state_prov').removeAttr('disabled').removeClass('ui-state-disabled'); for(i in data.state_prov_list) { $('#state_prov').append('<option value="'+i+'">'+data.state_prov_list[i]+'</option>'); } $('#state_prov').sort_select_box(); } else { $('#state_prov').removeAttr('disabled').removeClass('ui-state-disabled'); if(data && data.results) { for(i in data.results) { $('#state_prov').append('<option value="'+i+'">'+data.results[i]+'</option>'); } } $('#state_prov').sort_select_box(); } }, complete: function() { } }); } else { $('#state_prov').rules('remove', 'required'); $('#state_prov').empty().attr('disabled', 'disabled').addClass('ui-state-disabled'); } if($(this).find(':selected').hasClass('requires_postal_code')) { $('#postal').rules('add', { required: true, messages: { required: 'Postal code is required' } }); $('#postal').removeAttr('disabled'); } else { $('#postal').rules('remove', 'required'); $('#postal').val('').attr('disabled', 'disabled'); } } }); } function prepayToPctHandler(){ $('#pre-pay-amount').keyup(function(e) { var code = e.keyCode || e.which; if(code == 9) return false; var discount_percentage = Math.round(parseFloat(($(this).val() / term_total) * 100)); if(discount_percentage != prepay_discount_percentage) { $('#pre-pay-percentage').val(parseFloat(discount_percentage)).trigger('change'); prepay_discount_percentage = discount_percentage; } }); var prepay_discount_timer; $('#pre-pay-percentage').change(function() { clearTimeout(prepay_discount_timer); prepay_discount_timer = setTimeout(function() { calculate_discounts(); }, 1000); }).keyup(function() { var code = e.keyCode || e.which; if(code == 9) return false; if($(this).val() > 100) $(this).val(100); var discount_amount = parseFloat(term_total * ($(this).val() / 100)); $('#pre-pay-amount').val(parseInt(discount_amount)); }); } function contractTermHandler(){ $('#contract-term').change(function() { $('.review_results').display_review(); }); } function rentCheckboxHandler(){ for(bundle_id in bundle_list) { if(price_model[bundle_id]) { if(!price_model[bundle_id]['Buy'] && !price_model[bundle_id]['One Time']) { $('.mrc.mrc_'+bundle_id).attr('checked', 'checked').hide(); } } } } function shippingCalcUpdates(flag){ $('#form_Shipping').change(function(e) { var element = e.originalEvent.srcElement; if($(element).attr('name') == 'shipping_method') { return false; } calculate_shipping(); }); if(flag)$('.next_button').fadeIn().position({ my: "right bottom", at: "right top", of: "#form_categories"}); reviewButtonHandler(); closeReviewWindowHandler(); applyManagerDiscountHandler(); countrySelectorHandler(); contractTermHandler(); rentCheckboxHandler(); } function bundleSelectorHandler(id){ $('.bundle_selector.category_id_'+ id).change(function() { var bundle = $(this).val(); $('.bundle_selector_input').attr('name', bundle); $('.bundle_selector_price').text('$'+item_price[bundle]); $('.bundle_selector_label').text(decodeURIComponent(item_name[bundle])); }); $('.bundle_select_form_element.category_id_'+ id).first().each(function() { $(this).removeClass('ui-state-disabled').addClass('ui-state-highlight'); bundle_select_form_element_hover($(this)); }); } $.fn.display_review = function(settings) { var e = $(this); if($.type(settings) != 'object' || !$.isEmptyObject(settings)) { settings = {}; } var total_price = 0; var total_price_discount = 0; var total_mrc = 0; var total_mrc_discount = 0; var term_price = 0.00; var term_total_price = 0.00; $(e).html('<div class="review_title">Summary</div>'); $('.form_category_div').each(function() { var label = $(this).attr('category_title'); var label_id = 'review_category_'+label.replace(/[^a-zA-Z0-9_\-]/g, '_'); var data = $(this).review_data(); if(label != 'Shipping Information' && label != 'Contact Information' && label != 'Service Terms') { var t = '<h5 id="'+label_id+'" style="margin-top: 15px; background-image: url(/iconify?w=8&h=8&icon='+encodeURIComponent(label)+'); background-position: center left; background-repeat: no-repeat; padding-left: 18px; background-size: 11px 11px;">'+label+'</h5>'; if(data) { var cnt = 0; for(i in data) { cnt++; var buy = { price: 0.00, qty: 0, base: 0.00 }; var mrc = { price: 0.00, qty: 0, base: 0.00 }; if(data[i].is_rented > 0) { mrc.price = data[i].is_rented * item_mrc[i]; mrc.qty = data[i].is_rented; buy.price = ( data[i].value - data[i].is_rented ) * item_price[i]; buy.qty = data[i].value - data[i].is_rented; } else { buy.price = data[i].value * item_price[i]; buy.qty = data[i].value; } buy.base = buy.price; mrc.base = mrc.price; if(volume_discount[i]) { if(buy.price) buy.price = buy.price * (1-volume_discount[i]); if(mrc.price) mrc.price = mrc.price * (1-volume_discount[i]); } if(mrc.qty) term_price = term_price + mrc.price; if(prepay_discount[i]) { if(buy.price > 0) buy.price = buy.price * (1-prepay_discount[i]); if(mrc.price > 0) mrc.price = mrc.price * (1-prepay_discount[i]); } if(buy.qty) { total_price = total_price + buy.base; total_price_discount = total_price_discount + (buy.base - buy.price); buy.price = buy.price; } if(mrc.qty) { total_mrc = total_mrc + mrc.price; total_mrc_discount = total_mrc_discount + (mrc.base - mrc.price); total_price = total_price + mrc.price; } if(buy.qty > 0) { t = t+'<div class="review_label" category_id="Review" description="'+item_name[i]+'">'+data[i].value+' - '+data[i].label+'</div><div class="review_amount">$'+Math.ceil(buy.price)+'</div>'; } if(mrc.qty > 0) { t = t+'<div class="review_label" category_id="Review" description="'+item_name[i]+'">'+data[i].is_rented+' - '+data[i].label+'</div><div class="review_amount">$'+Math.ceil(mrc.price)+'/mo</div>'; } } if(cnt == 0) { t = t+'<div class="review_element" category_id="Review" description="No items selected in this category">No items selected</div>'; } } $(e).append('<div class="review_category">'+t+'</div>'); } }); var term_months; var prepay_amount = $('#pre-pay-percentage').val(); if(!prepay_amount) prepay_amount = 0.00; if(total_mrc > 0) { term_months = $('#contract-term').val(); if(!term_months) { term_months = 12; } term_total = (term_months - 1) * term_price; term_total_prepay = (term_months - 1) * total_mrc; } if(total_price_discount > 0 || total_mrc_discount > 0 || 1) { $(e).append('<div class="review_category"><h5 id="total_discounts" style="margin-top: 15px; background-image: url(/iconify?w=8&h=8&icon=total_discounts); background-position: center left; background-repeat: no-repeat; padding-left: 18px; background-size: 11px 11px;">Discounts Applied</h5>'); if(total_price_discount > 0) $(e).append('<div class="review_label">One Time: </div><div class="review_amount">$'+Math.ceil(total_price_discount)+'</div>'); if(total_mrc_discount > 0) $(e).append('<div class="review_label">Monthly: </div><div class="review_amount">$'+Math.ceil(total_mrc_discount)+'</div>'); $(e).append('</div>'); } $(e).append('<div class="review_category"><h5 id="total_price" style="margin-top: 15px; background-image: url(/iconify?w=8&h=8&icon=total_price); background-position: center left; background-repeat: no-repeat; padding-left: 18px; background-size: 11px 11px;">Total</h5>'); $(e).append('<div class="review_label" category_id="Review" description="Total Price">One Time: </div><div class="review_amount">$'+Math.ceil(total_price)+'</div>'); $(e).append('<div class="review_label" category_id="Review" description="Montly Price">Monthly: </div><div class="review_amount">$'+Math.ceil(total_mrc)+'</div>'); $(e).append('<div class="review_label" category_id="Review" description="Term Price">Total over '+term_months+' months: </div><div class="review_amount">$'+Math.ceil(term_total)+'</div>'); $(e).append('<div class="review_label" category_id="Review" description="Term Price">Pre-pay '+prepay_amount+'% over '+term_months+' months: </div><div class="review_amount">$'+Math.ceil(term_total_prepay)+'</div></div>'); $(e).mCustomScrollbar({ scrollButtons: { enable: true }, autoDraggerLength: true, advanced:{ updateOnBrowserResize:true, autoExpandHorizontalScroll:false } }); } $.fn.review_data = function(form_input_only) { var form_data = {}; $(this).find('input:not(.mrc),select:not(.mrc)').map(function(index, element) { var label; var name; var desc; var rent; var category = $(element).closest('.form_category_div').attr('id'); var category_id = $(element).closest('.form_category_div').attr('category_id'); var label_name = $(element).parent().prev().text(); if(category == 'Shipping' || category == 'Contact' || category == 'Discounts' || category == 'Terms') { return true; } if(element.type == 'select' || element.type == 'select-one') { label = item_name[$(element).val()]; name = $(element).val(); desc = item_description[$(element).val()]; } else { label = item_name[$(element).attr('name')]; name = $(element).attr('name'); desc = item_description[name]; } form_data[name] = {}; if(!label || label == undefined) label = 'Invalid item'; if(!form_input_only) form_data[name].label = decodeURIComponent(label); if(element.type == 'checkbox') { if($(element).is(':checked')) { form_data[name].value = 1; } } else { if(element.type == 'select' || element.type == 'select-one') { if($(element).attr('value')) { form_data[name].value = 1; } } else { if(element.type != 'submit') { form_data[name].value = $(element).val(); } } } if(!form_data[name].value) { delete form_data[name]; } if(form_data[name]) { form_data[name].id = name; if(!form_input_only) { form_data[name].desc = desc; form_data[name].category_id = category_id; form_data[name].category_name = category; form_data[name].label = label_name; } if($('.mrc_'+name+':checked').length > 0) form_data[name].is_rented = form_data[name].value; } }); return form_data; } function submit_quote() { $('#submit_button').addClass('ui-state-disabled').attr('disabled', 'true'); $('#status-message').text('Submitting Quote Information...'); $.ajax({ dataType: 'json', url: '/', data: { action: 'submit_quote', mode: 'Sales.Create_Quote' }, success: function(data) { $('#status-message').text('Your quote has been submitted. Loading confirmation page'); if(data && data.success) { window.location = '/?m=Sales.Create_Quote&action=complete&guid='+data.success; } else { alert("There was an error processing your quote. The server said:<br> "+data.error_msg+"<br>Please try again."); $('#submit_button').removeClass('ui-state-disabled').removeAttr('disabled'); } }, errorCallback: function(j, err) { $('#status-window').dialog('close'); } }); } function top_preview_form_element_hover(e) { var category_id = $(e).attr('category_id'); var item_id = $(e).attr('item_id'); top_preview_form_hover($(e), category_id, item_id); } function bundle_select_form_element_hover(e) { var category_id = $(e).attr('category_id'); var item_id = $(e).attr('item_id'); bundle_select_form_hover($(e), category_id, item_id); } function top_preview_form_hover(element, category_id, item_id) { if(!element || !category_id || !item_id) return false; description = item_description[item_id]; if(!description) description = 'No description available'; var item = element.text(); $('#top_preview_image_panel_'+category_id).html('<h4>'+item+'</h4><p><img src="/iconify?&w=100&h=100&icon='+item+'" align="left" width="100" height="100">'+description).fadeIn('slow'); } function bundle_select_form_hover(element, category_id, item_id) { if(!element || !category_id || !item_id) return false; description = item_description[item_id]; if(!description) description = 'No description available'; var item = element.text(); $('#preview_panel_'+category_id).html('<h4>'+item+'</h4><p><img src="/iconify?&w=100&h=100&icon='+item+'" align="left" width="100" height="100">'+description).fadeIn('slow'); } function get_shipping_info() { var form_data = {}; $('#Shipping').find('input,select').map(function(index, element) { form_data[$(element).attr('name')] = $(element).val(); }); return form_data; } function get_contact_info() { var form_data = {}; $('#Contact').find('input,select').map(function(index, element) { form_data[$(element).attr('name')] = $(element).val(); }); return form_data; } function save_contact() { contact_saved = false; contact_error = false; $('#status-message').text('Validating Contact Information...'); var form_data = get_contact_info(); var data = { action: 'save_contact', mode: 'Sales.Create_Quote', form_data: JSON.stringify(form_data) }; if(contact_xhr && contact_xhr.readyState != 4) { contact_xhr.abort(); } contact_xhr = $.ajax({ url: '/', dataType: 'JSON', type: 'POST', data: data, success: function(data) { if(!data.success) { contact_error = data.error_msg; alert('Could not validate contact information.'); } contact_saved = true; $('#status-message').text('Contact Information Validated.'); }, errorCallback: function(j, error) { if(contact_xhr.readyState > 0) contact_error = error; } }); } function save_shipping() { shipping_saved = false; shipping_error = false; $('#status-message').text('Validating Shipping Information...'); var form_data = get_shipping_info(); var data = { action: 'save_shipping', mode: 'Sales.Create_Quote', form_data: JSON.stringify(form_data) }; if(shipping_xhr && shipping_xhr.readyState != 4) { shipping_xhr.abort(); } shipping_saved = false; shipping_xhr = $.ajax({ url: '/', dataType: 'JSON', type: 'POST', data: data, success: function(data) { if(!data.success) { shipping_error = data.error_msg; } shipping_saved = true; $('#status-message').text('Shipping Information Validated.'); }, errorCallback: function(j, error) { if(shipping_xhr.readyState > 0) shipping_error = error; } }); } function save_progress() { progress_saved = false; progress_error = false; $('#status-message').text('Saving Quote Information...'); if(sync_changes == false) { progress_saved = true; $('#status-message').text('Quote Information Saved.'); return true; } var form_data = $('#form_components').review_data(1); var data = {}; data.action = 'save_progress'; data.mode = 'Sales.Create_Quote'; data.form_data = JSON.stringify(form_data); data.term_in_months = $('#contract-term').val(); data.prepay_amount = $('#pre-pay-percentage').val(); if(progress_xhr && progress_xhr.readyState != 4) { progress_xhr.abort(); } progress_xhr = $.ajax({ url: '/', dataType: 'JSON', type: 'POST', data: data, success: function(data) { sync_changes = false; if(!data.success) { progress_error = data.error_msg; } $('#status-message').text('Quote Information Saved.'); progress_saved = true; }, errorCallback: function(j, err) { if(progress_xhr.readyState > 0) progress_error = err; } }); } function save_pre_form_category(category, category_name) { $('#bundle_select_submit').fadeOut(); var form_data = $('#form_category_'+category_name).review_data(1); if($.isEmptyObject(form_data)) { $('#bundle_select_submit').fadeIn(); alert('Please enter a value'); return false; } $('#status-message').text('Saving your selection...'); $('#status-window').dialog('open'); var data = { action: 'save_pre_form_category', mode: 'Sales.Create_Quote', form_data: JSON.stringify(form_data), category: category }; $.ajax({ url: '/', dataType: 'JSON', type: 'POST', data: data, success: function(data) { $('#status-message').text('Selection saved. Please wait...'); if(data.success) { window.location = '/?m=Sales.Create_Quote'; } else { $('#status-window').dialog('close'); $('#bundle_select_submit').fadeIn(); } } }); } function validate_forms() { var change_index; var change_to = 0; $('.form_category_div').each(function() { var category = $(this).attr('id'); if($('#form_'+category).valid()) { $('#icon_'+category).parent().removeClass('category_icon_error'); } else { $('#icon_'+category).parent().addClass('category_icon_error'); if(!change_index) change_index = change_to; } change_to++; }); if(change_index) { $('#form_components').tabs("select", change_index); return false; } $(".display_right_preview_form").mCustomScrollbar("update"); return true; } function init_shipping() { return true; if($('#shipping_method').children().length <= 1) { calculate_shipping(); } } function calculate_discounts() { prepay_discount = {}; volume_discount = {}; var form_data = {}; $('#pre-pay-discount-status').html('&nbsp;&nbsp;% Calculating..'); form_data.quote_json = $('#form_components').review_data(1); form_data.prepay_amount = parseFloat($('#pre-pay-percentage').val()); form_data.term_in_months = parseInt($('#contract-term').val()); var data = { action: 'calculate_discounts', mode: 'Sales.Create_Quote', prepay_amount: form_data.prepay_amount, term_in_months: form_data.term_in_months }; if(discount_xhr && discount_xhr.ready_state != 4) discount_xhr.abort(); discount_xhr = $.ajax({ url: '/', dataType: 'json', type: 'POST', data: data, success: function(data) { if(data && data.status == 1) { if(data.results && data.results.total_discount && data.results.total_discount > 0) { for(i in data.results.apply_to) { volume_discount[i] = data.results.volume_discount; prepay_discount[i] = data.results.prepay_discount; } $('.review_results').display_review(); } } else { alert('Could not retrieve discount calculation from server!'); } }, complete: function() { $('#pre-pay-discount-status').html('&nbsp;&nbsp;%'); } }); } function calculate_shipping() { var shipping_fields = new Array('addr1', 'city', 'state_prov', 'postal', 'country'); var shipping_data = {}; for(i in shipping_fields) { shipping_data[shipping_fields[i]] = $('#'+shipping_fields[i]).val(); } if(!shipping_data.country) { return true; } if(shipping_data.country == 'US' || shipping_data.country == 'CA') { if(!shipping_data.addr1 || !shipping_data.city || !shipping_data.state_prov || !shipping_data.postal) { return true; } } else { if(!shipping_fields.addr1 || !$shipping_fields.city) return; } $('#shipping_method').children().remove(); $('#shipping_method').addClass('ui-state-disabled').append($('<option>', { value: '' }).text('Calculating..')); shipping_saved = false; progress_saved = false; save_shipping(); shipping_status = setInterval(function() { if(shipping_saved == true) { shipping_saved = false; clearInterval(shipping_status); if(shipping_error && shipping_error != "") { alert(shipping_error); } else { save_progress(); progress_status = setInterval(function() { if(progress_saved == true) { progress_saved = false; clearInterval(progress_status); if(progress_error) { alert(progress_error); } else { if(shipping_calculator_xhr && shipping_calculator_xhr.ready_state != 4) shipping_calculator_xhr.abort(); var shipping_calculator_xhr = $.ajax({ url: '/', data: { mode: 'Sales.Create_Quote', action: 'calculate_shipping' }, type: 'POST', dataType: 'JSON', success: function(data) { if(data && data.services) { for(i in data.services) { $('#shipping_method').append($('<option>', { value: data.services[i].service }).text(data.services[i].carrier + ' ' + data.services[i].service + ' ($'+data.services[i].rate+')')); } $('#shipping_method').children().first().text('Select shipping service'); $('#shipping_method').removeAttr('disabled').removeClass('ui-state-disabled'); } }, complete: function() { } }); } } }, 100); } } }, 100); } function cors { }$(function() { $( "#dialog-message" ).dialog({ modal: true, buttons: { Ok: function() { $( this ).dialog( "close" ); } }, autoOpen: false }); $( "#dialog-open" ).click(function() { $('#dialog-message').dialog('open'); }); });